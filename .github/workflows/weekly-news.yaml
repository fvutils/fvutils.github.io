name: Weekly News Report

# Generates weekly news reports from organization activity

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  generate-news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install GitHub CLI
        run: |
          type -p gh >/dev/null || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y)

      - name: Gather Weekly Activity
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Calculate date range (last 7 days)
          END_DATE=$(date -u +%Y-%m-%d)
          START_DATE=$(date -u -d '7 days ago' +%Y-%m-%d)
          
          echo "Gathering activity from $START_DATE to $END_DATE"
          
          # Gather recent commits, PRs, and issues from fvutils organization
          echo "## Recent Activity Report ($START_DATE to $END_DATE)" > /tmp/activity.md
          echo "" >> /tmp/activity.md
          
          # Get list of repositories in the organization
          REPOS=$(gh repo list fvutils --limit 100 --json name --jq '.[].name')
          
          echo "### Commits" >> /tmp/activity.md
          for repo in $REPOS; do
            echo "Checking $repo..."
            COMMITS=$(gh api "repos/fvutils/$repo/commits?since=${START_DATE}T00:00:00Z&until=${END_DATE}T23:59:59Z" --jq '.[] | "- \(.commit.message | split("\n")[0]) (\(.sha[0:7])) in fvutils/\(env.repo)"' 2>/dev/null || echo "")
            if [ -n "$COMMITS" ]; then
              echo "$COMMITS" >> /tmp/activity.md
            fi
          done
          echo "" >> /tmp/activity.md
          
          echo "### Pull Requests" >> /tmp/activity.md
          for repo in $REPOS; do
            PRS=$(gh pr list --repo fvutils/$repo --state all --search "updated:>=$START_DATE" --json number,title,state,author --jq '.[] | "- #\(.number): \(.title) (\(.state)) by @\(.author.login) in fvutils/\(env.repo)"' 2>/dev/null || echo "")
            if [ -n "$PRS" ]; then
              echo "$PRS" >> /tmp/activity.md
            fi
          done
          echo "" >> /tmp/activity.md
          
          echo "### Issues" >> /tmp/activity.md
          for repo in $REPOS; do
            ISSUES=$(gh issue list --repo fvutils/$repo --state all --search "updated:>=$START_DATE" --json number,title,state,author --jq '.[] | "- #\(.number): \(.title) (\(.state)) by @\(.author.login) in fvutils/\(env.repo)"' 2>/dev/null || echo "")
            if [ -n "$ISSUES" ]; then
              echo "$ISSUES" >> /tmp/activity.md
            fi
          done
          
          cat /tmp/activity.md

      - name: Generate Short News Update
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          WEEK_NUM=$(date -u +%V)
          YEAR=$(date -u +%Y)
          
          # Create prompt file for copilot
          cat > /tmp/prompt.txt << 'EOF'
Based on the following GitHub activity from the past week, create a concise 2-3 paragraph news update suitable for a website news section. Focus on the most significant changes and developments. Keep it professional and informative.

EOF
          cat /tmp/activity.md >> /tmp/prompt.txt
          
          # Use gh copilot with gpt-5-mini
          gh copilot suggest -p "$(cat /tmp/prompt.txt)" --model gpt-5-mini > /tmp/short_news.txt

      - name: Generate Detailed Overview
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create prompt file for detailed overview
          cat > /tmp/detail_prompt.txt << 'EOF'
Based on the following GitHub activity from the past week, create a detailed weekly overview with sections for different types of changes (commits, pull requests, issues). Include relevant details and provide context about the significance of changes. Format as markdown.

EOF
          cat /tmp/activity.md >> /tmp/detail_prompt.txt
          
          # Use gh copilot to generate detailed overview
          gh copilot suggest -p "$(cat /tmp/detail_prompt.txt)" --model gpt-5-mini > /tmp/detailed_overview.txt

      - name: Create News Post
        run: |
          POST_DATE=$(date -u +%Y-%m-%d)
          WEEK_NUM=$(date -u +%V)
          YEAR=$(date -u +%Y)
          POST_FILE="_posts/${POST_DATE}-weekly-update-${YEAR}-w${WEEK_NUM}.md"
          
          cat > "$POST_FILE" << 'EOFPOST'
          ---
          layout: post
          title: "FVUtils Weekly Update - Week WEEK_NUM, YEAR"
          date: POST_DATE
          ---

          SHORT_NEWS

          ## Detailed Activity Overview

          DETAILED_OVERVIEW

          ---

          *This weekly update was automatically generated based on activity across FVUtils repositories.*
          EOFPOST
          
          # Replace placeholders
          sed -i "s/WEEK_NUM/$WEEK_NUM/g" "$POST_FILE"
          sed -i "s/YEAR/$YEAR/g" "$POST_FILE"
          sed -i "s/POST_DATE/$POST_DATE/g" "$POST_FILE"
          
          # Insert generated content
          sed -i "/SHORT_NEWS/r /tmp/short_news.txt" "$POST_FILE"
          sed -i "/SHORT_NEWS/d" "$POST_FILE"
          
          sed -i "/DETAILED_OVERVIEW/r /tmp/detailed_overview.txt" "$POST_FILE"
          sed -i "/DETAILED_OVERVIEW/d" "$POST_FILE"
          
          echo "Created post: $POST_FILE"
          cat "$POST_FILE"

      - name: Commit and Push
        run: |
          git add _posts/*.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            POST_DATE=$(date -u +%Y-%m-%d)
            WEEK_NUM=$(date -u +%V)
            git commit -m "Add weekly update for week $WEEK_NUM"
            git push
            echo "Weekly news post published!"
          fi
