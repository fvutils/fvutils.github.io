name: FVUtils Weekly Report

on:
  schedule:
  - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  discussions: write

jobs:
  generate-news:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: |
          type -p gh >/dev/null || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y)
      
      - name: Install GitHub Copilot CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh extension install github/gh-copilot || gh extension upgrade gh-copilot || true

      - name: Gather Weekly Activity
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          END_DATE=$(date -u +%Y-%m-%d)
          START_DATE=$(date -u -d '7 days ago' +%Y-%m-%d)
          
          echo "Gathering activity from $START_DATE to $END_DATE"
          
          echo "## Recent Activity Report ($START_DATE to $END_DATE)" > /tmp/activity.md
          echo "" >> /tmp/activity.md
          
          REPOS=$(gh repo list fvutils --limit 100 --json name --jq '.[].name')
          
          echo "### Commits" >> /tmp/activity.md
          for repo in $REPOS; do
            echo "Checking $repo..."
            COMMITS=$(gh api "repos/fvutils/$repo/commits?since=${START_DATE}T00:00:00Z&until=${END_DATE}T23:59:59Z" --jq '.[] | "- \(.commit.message | split("\n")[0]) (\(.sha[0:7])) in fvutils/\(env.repo)"' 2>/dev/null || echo "")
            if [ -n "$COMMITS" ]; then
              echo "$COMMITS" >> /tmp/activity.md
            fi
          done
          echo "" >> /tmp/activity.md
          
          echo "### Pull Requests" >> /tmp/activity.md
          for repo in $REPOS; do
            PRS=$(gh pr list --repo fvutils/$repo --state all --search "updated:>=$START_DATE" --json number,title,state,author --jq '.[] | "- #\(.number): \(.title) (\(.state)) by @\(.author.login) in fvutils/\(env.repo)"' 2>/dev/null || echo "")
            if [ -n "$PRS" ]; then
              echo "$PRS" >> /tmp/activity.md
            fi
          done
          echo "" >> /tmp/activity.md
          
          echo "### Issues" >> /tmp/activity.md
          for repo in $REPOS; do
            ISSUES=$(gh issue list --repo fvutils/$repo --state all --search "updated:>=$START_DATE" --json number,title,state,author --jq '.[] | "- #\(.number): \(.title) (\(.state)) by @\(.author.login) in fvutils/\(env.repo)"' 2>/dev/null || echo "")
            if [ -n "$ISSUES" ]; then
              echo "$ISSUES" >> /tmp/activity.md
            fi
          done
          
          cat /tmp/activity.md

      - name: Generate AI Summary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Read the activity data
          ACTIVITY=$(cat /tmp/activity.md)
          
          # Create prompt file for AI model
          cat > /tmp/prompt.txt << 'PROMPT_EOF'
          Based on the following weekly activity report, create a concise summary paragraph (2-3 sentences) highlighting the key accomplishments and overall development direction.
          
          PROMPT_EOF
          
          cat /tmp/activity.md >> /tmp/prompt.txt
          
          # Read the complete prompt
          PROMPT=$(cat /tmp/prompt.txt)
          
          # Use GitHub Models API (GPT-4) to generate summary
          RESPONSE=$(gh api \
            -X POST \
            /models/gpt-4o-mini/chat/completions \
            -f model='gpt-4o-mini' \
            -f messages[][role]='user' \
            -f messages[][content]="$PROMPT" \
            -F max_tokens=150 \
            -F temperature=0.7 2>&1) || {
            # Fallback if API fails: create basic summary
            COMMIT_COUNT=$(grep -c "^- .*(.{7}) in fvutils/" /tmp/activity.md || echo "0")
            echo "This week saw continued development across FVUtils repositories with $COMMIT_COUNT commits and various updates. The team remains focused on enhancing features, fixing bugs, and improving project infrastructure." > /tmp/summary.md
            echo "Fallback summary (API unavailable):"
            cat /tmp/summary.md
            exit 0
          }
          
          # Extract the AI-generated content
          echo "$RESPONSE" | jq -r '.choices[0].message.content' > /tmp/summary.md 2>/dev/null || {
            # Fallback if parsing fails
            echo "This week saw active development across FVUtils repositories with multiple commits, pull requests, and issue updates. Development continues with focus on feature enhancements and project improvements." > /tmp/summary.md
          }
          
          echo "AI-generated summary:"
          cat /tmp/summary.md

      - name: Create Discussion Post
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          WEEK_NUM=$(date -u +%V)
          YEAR=$(date -u +%Y)
          TITLE="Weekly Update - Week $WEEK_NUM, $YEAR"
          
          # Build discussion body with AI summary first, then detailed activity
          echo "## Summary" > /tmp/discussion_body.md
          echo "" >> /tmp/discussion_body.md
          cat /tmp/summary.md >> /tmp/discussion_body.md
          echo "" >> /tmp/discussion_body.md
          echo "---" >> /tmp/discussion_body.md
          echo "" >> /tmp/discussion_body.md
          cat /tmp/activity.md >> /tmp/discussion_body.md
          echo "" >> /tmp/discussion_body.md
          echo "---" >> /tmp/discussion_body.md
          echo "" >> /tmp/discussion_body.md
          echo "*This weekly update was automatically generated based on activity across FVUtils repositories.*" >> /tmp/discussion_body.md
          
          # Read body content
          BODY=$(cat /tmp/discussion_body.md)
          
          # Create the discussion using GraphQL API
          # We use jq to properly escape the JSON fields
          gh api graphql -f query='
            mutation($repositoryId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
              createDiscussion(input: {
                repositoryId: $repositoryId
                categoryId: $categoryId
                title: $title
                body: $body
              }) {
                discussion {
                  id
                  url
                  title
                }
              }
            }
          ' -f repositoryId="R_kgDOHMTiUw" \
            -f categoryId="DIC_kwDOHMTiU84C2BrA" \
            -f title="$TITLE" \
            -f body="$BODY" | jq -r '.data.createDiscussion.discussion | "Created discussion: \(.title)\nURL: \(.url)"'
