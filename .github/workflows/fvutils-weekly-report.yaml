name: FVUtils Weekly Report

on:
#  schedule:
#    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  discussions: write

jobs:
  generate-news:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: |
          type -p gh >/dev/null || (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y)

      - name: Gather Weekly Activity
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          END_DATE=$(date -u +%Y-%m-%d)
          START_DATE=$(date -u -d '7 days ago' +%Y-%m-%d)
          
          echo "Gathering activity from $START_DATE to $END_DATE"
          
          echo "## Recent Activity Report ($START_DATE to $END_DATE)" > /tmp/activity.md
          echo "" >> /tmp/activity.md
          
          REPOS=$(gh repo list fvutils --limit 100 --json name --jq '.[].name')
          
          echo "### Commits" >> /tmp/activity.md
          for repo in $REPOS; do
            echo "Checking $repo..."
            COMMITS=$(gh api "repos/fvutils/$repo/commits?since=${START_DATE}T00:00:00Z&until=${END_DATE}T23:59:59Z" --jq '.[] | "- \(.commit.message | split("\n")[0]) (\(.sha[0:7])) in fvutils/\(env.repo)"' 2>/dev/null || echo "")
            if [ -n "$COMMITS" ]; then
              echo "$COMMITS" >> /tmp/activity.md
            fi
          done
          echo "" >> /tmp/activity.md
          
          echo "### Pull Requests" >> /tmp/activity.md
          for repo in $REPOS; do
            PRS=$(gh pr list --repo fvutils/$repo --state all --search "updated:>=$START_DATE" --json number,title,state,author --jq '.[] | "- #\(.number): \(.title) (\(.state)) by @\(.author.login) in fvutils/\(env.repo)"' 2>/dev/null || echo "")
            if [ -n "$PRS" ]; then
              echo "$PRS" >> /tmp/activity.md
            fi
          done
          echo "" >> /tmp/activity.md
          
          echo "### Issues" >> /tmp/activity.md
          for repo in $REPOS; do
            ISSUES=$(gh issue list --repo fvutils/$repo --state all --search "updated:>=$START_DATE" --json number,title,state,author --jq '.[] | "- #\(.number): \(.title) (\(.state)) by @\(.author.login) in fvutils/\(env.repo)"' 2>/dev/null || echo "")
            if [ -n "$ISSUES" ]; then
              echo "$ISSUES" >> /tmp/activity.md
            fi
          done
          
          cat /tmp/activity.md

      - name: Generate Short News Update
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          cat > /tmp/prompt.txt << 'EOF'
          Based on the following GitHub activity from the past week, create a concise 2-3 paragraph news update suitable for a website news section. Focus on the most significant changes and developments. Keep it professional and informative.
          
          EOF
          cat /tmp/activity.md >> /tmp/prompt.txt
          
          gh copilot -p "$(cat /tmp/prompt.txt)" > /tmp/short_news.txt

      - name: Generate Detailed Overview
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          cat > /tmp/detail_prompt.txt << 'EOF'
          Based on the following GitHub activity from the past week, create a detailed weekly overview with sections for different types of changes (commits, pull requests, issues). Include relevant details and provide context about the significance of changes. Format as markdown.
          
          EOF
          cat /tmp/activity.md >> /tmp/detail_prompt.txt
          
          gh copilot -p "$(cat /tmp/detail_prompt.txt)" > /tmp/detailed_overview.txt

      - name: Create Discussion Post
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          WEEK_NUM=$(date -u +%V)
          YEAR=$(date -u +%Y)
          TITLE="Weekly Update - Week $WEEK_NUM, $YEAR"
          
          # Combine short summary and detailed overview into body
          cat /tmp/short_news.txt > /tmp/discussion_body.md
          echo "" >> /tmp/discussion_body.md
          echo "## Detailed Activity Overview" >> /tmp/discussion_body.md
          echo "" >> /tmp/discussion_body.md
          cat /tmp/detailed_overview.txt >> /tmp/discussion_body.md
          echo "" >> /tmp/discussion_body.md
          echo "---" >> /tmp/discussion_body.md
          echo "" >> /tmp/discussion_body.md
          echo "*This weekly update was automatically generated based on activity across FVUtils repositories.*" >> /tmp/discussion_body.md
          
          # Read body content
          BODY=$(cat /tmp/discussion_body.md)
          
          # Create the discussion using GraphQL API
          # We use jq to properly escape the JSON fields
          gh api graphql -f query='
            mutation($repositoryId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
              createDiscussion(input: {
                repositoryId: $repositoryId
                categoryId: $categoryId
                title: $title
                body: $body
              }) {
                discussion {
                  id
                  url
                  title
                }
              }
            }
          ' -f repositoryId="R_kgDOHMTiUw" \
            -f categoryId="DIC_kwDOHMTiU84C2BrA" \
            -f title="$TITLE" \
            -f body="$BODY" | jq -r '.data.createDiscussion.discussion | "Created discussion: \(.title)\nURL: \(.url)"'
